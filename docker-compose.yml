version: '3.8'

services:
  # MongoDB for non-relational data
  mongodb:
    image: mongo:7.0
    container_name: delivery_mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: delivery_platform

  # PostgreSQL for transactional data
  postgres:
    image: postgres:16
    container_name: delivery_postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./src/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      POSTGRES_DB: delivery_platform
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

  # Redis for caching and message queuing
  redis:
    image: redis:7-alpine
    container_name: delivery_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # Nginx for load balancing
  nginx:
    image: nginx:alpine
    container_name: delivery_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - gateway

  # API Gateway
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: delivery_gateway
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGODB_URI: mongodb://mongodb:27017/delivery_platform
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
    depends_on:
      - mongodb
      - postgres
      - redis
    command: npm run start

  # User Service
  user-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: user_service
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGODB_URI: mongodb://mongodb:27017/delivery_platform
      REDIS_HOST: redis
    depends_on:
      - mongodb
      - redis
    command: npm run start:user

  # Restaurant Service
  restaurant-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: restaurant_service
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: production
      PORT: 3002
      MONGODB_URI: mongodb://mongodb:27017/delivery_platform
      REDIS_HOST: redis
    depends_on:
      - mongodb
      - redis
    command: npm run start:restaurant

  # Order Service
  order-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: order_service
    ports:
      - "3003:3003"
    environment:
      NODE_ENV: production
      PORT: 3003
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
    depends_on:
      - postgres
      - redis
    command: npm run start:order

  # Delivery Service (Partner Assignment & Route Optimization)
  delivery-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: delivery_service
    ports:
      - "3004:3004"
    environment:
      NODE_ENV: production
      PORT: 3004
      MONGODB_URI: mongodb://mongodb:27017/delivery_platform
      REDIS_HOST: redis
    depends_on:
      - mongodb
      - redis
    command: npm run start:delivery

  # Tracking Service (Real-time WebSocket)
  tracking-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tracking_service
    ports:
      - "3005:3005"
    environment:
      NODE_ENV: production
      PORT: 3005
      REDIS_HOST: redis
    depends_on:
      - redis
    command: npm run start:tracking

  # Fraud Detection Service
  fraud-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fraud_service
    ports:
      - "3006:3006"
    environment:
      NODE_ENV: production
      PORT: 3006
      MONGODB_URI: mongodb://mongodb:27017/delivery_platform
      REDIS_HOST: redis
    depends_on:
      - mongodb
      - redis
    command: npm run start:fraud

  # Payment Service
  payment-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: payment_service
    ports:
      - "3007:3007"
    environment:
      NODE_ENV: production
      PORT: 3007
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
    depends_on:
      - postgres
      - redis
    command: npm run start:payment

volumes:
  mongodb_data:
  postgres_data:
  redis_data:
